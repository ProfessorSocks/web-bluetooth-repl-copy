<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />

    <!-- SEO title & description -->
    <title>MicroPython Web REPL | Silicon Witchery</title>
    <meta name="description"
        content="Web Bluetooth based REPL for MicroPython running on Silicon Witchery FPGA modules.">
    <link rel="canonical" href="https://repl.siliconwitchery.com" />

    <!-- Facebook & Twitter card meta -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@SiliconWitchery" />
    <meta property="og:title" content="MicroPython Web REPL | Silicon Witchery" />
    <meta property="og:description"
        content="Web Bluetooth based REPL for MicroPython running on Silicon Witchery FPGA modules." />
    <meta property="og:image" content="https://repl.siliconwitchery.com/images/share.png" />
    <meta property="og:url" content="https://repl.siliconwitchery.com" />
    <meta property="og:type" content="website" />

    <!-- Import the bluetooth functions from the bluetooth.js file -->
    <script src="bluetooth.js"></script>

</head>

<body>

    <div class="app">
        <div style="display: flex; justify-content: space-between;">
            <h1>MicroPython Web REPL</h1>
            <img id="bluetoothIcon" src="/images/no-bluetooth-icon.svg" height="30" style="padding-top: 5px;">
        </div>

        <!-- Latest version and docs link -->
        <p>Latest MicroPython build:
            <a href="https://github.com/siliconwitchery/s1-micropython/releases/latest" target="_blank"
                id="latestVersion"></a>.
            Use <b>machine.git_tag</b> to check your current version. For full reference, check out the
            <a href="https://docs.siliconwitchery.com/micropython/micropython/" target="_blank">documentation</a>.
        </p>

        <!-- REPL console -->
        <textarea type="text" id="replConsole" rows=20 autocomplete="off" autocorrect="off" autocapitalize="off"
            spellcheck="false" placeholder="" onpaste="pasteEvent();event.preventDefault()"></textarea>

        <!-- Buttons -->
        <div class="buttons">

            <button id="connectButton" title="Open Bluetooth connection pane">Connect</button>

            <button onclick="queueReplData('\x01'); replConsole.focus()" name="controlButton" disabled
                title="Enter raw REPL mode (Ctrl-A)">Ctrl-A</button>

            <button onclick="queueReplData('\x02'); replConsole.focus()" name="controlButton" disabled
                title="Enter normal REPL mode (Ctrl-B)">Ctrl-B</button>

            <button onclick="queueReplData('\x03'); replConsole.focus()" name="controlButton" disabled
                title="Interrupt a running program (Ctrl-C)">Ctrl-C</button>

            <button onclick="queueReplData('\x04'); replConsole.focus()" name="controlButton" disabled
                title="Reset the device (Ctrl-D)">Ctrl-D</button>

            <button onclick="queueReplData('\x05'); replConsole.focus()" name="controlButton" disabled
                title="Enter paste mode (Ctrl-E)">Ctrl-E</button>

            <button onclick="replConsole.value = ''; cursorPosition = 0; queueReplData('\x03'); replConsole.focus()"
                title="Clear console (Cmd-k or Ctrl-k)">Clear</button>

        </div>

        <footer>

            <p>For help, bug reporting, and source code, visit the
                <a href="https://github.com/siliconwitchery/web-bluetooth-repl" target="_blank">repository</a>
            </p>

            <p>Copyright Â© 2023 <a href="https://www.siliconwitchery.com" target="_blank">Silicon Witchery</a></p>

        </footer>

    </div>

</body>

<!-- Javascript for interacting with the REPL console and buttons -->
<script>

    window.addEventListener("load", (event) => {
        replConsole.placeholder =
            "Welcome to the MicroPython Web REPL. Connect via Bluetooth using the button below.\n\n" +
            "Currently, only Chrome desktop supports Web Bluetooth which is used here.\n\n" +
            "You're welcome to fork, contribute, and suggest bugfixes for this code within the repository linked below.";
    });

    const bluetoothIcon = document.getElementById('bluetoothIcon');
    const replConsole = document.getElementById('replConsole');
    const connectButton = document.getElementById('connectButton');
    const controlButtons = document.getElementsByName('controlButton');

    // Variable for keeping track of the current cursor position
    var cursorPosition = 0;

    connectButton.addEventListener('click', () => {

        connectDisconnect()
            .then(result => {
                if (result === "connected") {

                    replConsole.placeholder = "";

                    connectButton.innerHTML = "Disconnect";

                    controlButtons.forEach(ele => {
                        ele.disabled = false;
                    })

                    replConsole.focus()

                    bluetoothIcon.src = "/images/bluetooth-icon.svg"

                    queueReplData("\x03"); // Send Ctrl-C to get a prompt
                }
            })

            .catch(error => {

                bluetoothIcon.src = "/images/no-bluetooth-icon.svg"

                console.error(error);
            })
    })

    replConsole.onkeypress = (event) => {

        // Create a mutable copy of the event.key value
        let key = event.key;

        if (key === 'Enter') {

            key = "\r\n";

            queueReplData("\x1B[F"); // Send End key before sending \r\n
        }

        queueReplData(key)

        // Don't print characters to the REPL console because the response will print it for us
        event.preventDefault();
    }

    // Whenever keys such as Ctrl, Tab or Backspace are pressed/held
    replConsole.onkeydown = (event) => {

        // If Ctrl is held
        if (event.ctrlKey) {
            switch (event.key) {

                case 'a':

                    queueReplData("\x01"); // Send Ctrl-A
                    event.preventDefault(); // Prevent select all
                    return;

                case 'b':

                    queueReplData("\x02"); // Send Ctrl-B
                    event.preventDefault();
                    return;

                case 'c':

                    queueReplData("\x03"); // Send Ctrl-C
                    event.preventDefault(); // Prevent copy
                    return;

                case 'd':

                    queueReplData("\x04"); // Send Ctrl-D
                    event.preventDefault();
                    return;

                case 'e':

                    queueReplData("\x05"); // Send Ctrl-E
                    event.preventDefault();
                    return;
            }
        }

        // If the meta/command key is held
        if (event.metaKey) {
            switch (event.key) {

                case 'k':

                    replConsole.value = "";
                    cursorPosition = 0;
                    queueReplData("\x03"); // Send Ctrl-C
                    event.preventDefault();
                    return;

                case 'Backspace':

                    queueReplData(
                        "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b" +
                        "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b" +
                        "\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b\b");
                    event.preventDefault();
                    return;

                case 'ArrowRight':

                    queueReplData("\x1B[F"); // Send End key
                    event.preventDefault();
                    return;

                case 'ArrowLeft':

                    queueReplData("\x1B[H"); // Send Home key
                    event.preventDefault();
                    return;
            }
        }

        if (event.key === 'Backspace') {

            queueReplData("\x08"); // Send backspace
            event.preventDefault();
            return;
        }

        if (event.key === 'ArrowUp') {

            queueReplData("\x1B[A"); // Send up arrow key
            event.preventDefault();
            return;
        }

        if (event.key === 'ArrowDown') {

            queueReplData("\x1B[B"); // Send down arrow key
            event.preventDefault();
            return;
        }

        if (event.key === 'ArrowRight') {

            queueReplData("\x1B[C"); // Send right arrow key
            event.preventDefault();
            return;
        }

        if (event.key === 'ArrowLeft') {

            queueReplData("\x1B[D"); // Send left arrow key
            event.preventDefault();
            return;
        }

        if (event.key === 'Tab') {

            queueReplData("\x09"); // Send Tab key
            event.preventDefault();
            return;
        }
    }

    function pasteEvent() {

        navigator.clipboard.readText()
            .then(text => {

                // Micropython requires \r\n
                queueReplData(text.replace('\n', '\r\n'))
            })

            .catch(() => {

                alert("Could not paste. Did you allow clipboard permissions?");
            });
    }

    function receiveReplData(event) {

        // Decode the byte array into a UTF-8 string
        const decoder = new TextDecoder('utf-8');
        let value = event.target.value;
        let string = decoder.decode(value);

        // For every character in the string, i is incremented internally
        for (let i = 0; i < string.length;) {

            // Move cursor back one if there is a backspace
            if (string.indexOf('\b', i) == i) {

                cursorPosition--;
                i += '\b'.length;
            }

            // Skip carriage returns. We only need newlines '\n'
            else if (string.indexOf('\r', i) == i) {

                i += '\r'.length;
            }

            // ESC-[K deletes to the end of the line
            else if (string.indexOf('\x1B[K', i) == i) {

                replConsole.value = replConsole.value.slice(0, cursorPosition);
                i += '\x1B[K'.length;
            }

            // ESC-[nD moves backwards n characters
            else if (string.slice(i).search(/\x1B\[\d+D/) == 0) {

                // Extract the number of spaces to move
                let backspaces = parseInt(string.slice(i).match(/(\d+)(?!.*\1)/g));
                cursorPosition -= backspaces;
                i += '\x1B[D'.length + String(backspaces).length;
            }

            // Append other characters as normal
            else {

                replConsole.value = replConsole.value.slice(0, cursorPosition)
                    + string[i]
                    + replConsole.value.slice(cursorPosition + 1);

                cursorPosition++;
                i++;
            }
        }

        // Reposition the cursor
        replConsole.selectionEnd = cursorPosition;
        replConsole.selectionStart = cursorPosition;

        replConsole.scrollTop = replConsole.scrollHeight;
    }

    function receiveRawData(event) {

        console.log(event.target.value);
    }

    function disconnectHandler() {

        bluetoothIcon.src = "/images/no-bluetooth-icon.svg"

        connectButton.innerHTML = "Connect";

        controlButtons.forEach(ele => {
            ele.disabled = true;
        })
    }

</script>

<!-- Populates the latest MicroPython version number via an API -->
<script type="module">

    import { Octokit } from "https://cdn.skypack.dev/@octokit/core";

    const latestVersion = document.getElementById('latestVersion');

    (async function getVersion() {

        const octokit = new Octokit({});
        const latestRelease = await octokit.request('GET /repos/{owner}/{repo}/releases/latest', {
            owner: 'siliconwitchery',
            repo: 's1-micropython'
        });

        latestVersion.innerHTML = latestRelease.data.tag_name;
    })();

</script>

</html>